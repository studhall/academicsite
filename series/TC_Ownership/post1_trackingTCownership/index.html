<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David Hall">
<meta name="dcterms.date" content="2025-08-08">
<meta name="description" content="Ownership shares by state over time with animated maps.">

<title>Tracking TC Ownership: Descriptive Stats â€“ David Hall</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-f32118e2f0abedbe9034b1e6846ded24.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">David Hall</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../teaching.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../data.html"> 
<span class="menu-text">Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../cv.html"> 
<span class="menu-text">CV</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#comparing-the-ownership-of-hospitals-and-tcs-nationally" id="toc-comparing-the-ownership-of-hospitals-and-tcs-nationally" class="nav-link" data-scroll-target="#comparing-the-ownership-of-hospitals-and-tcs-nationally">Comparing the Ownership of Hospitals and TCs Nationally</a></li>
  <li><a href="#heterogeneity-by-state" id="toc-heterogeneity-by-state" class="nav-link" data-scroll-target="#heterogeneity-by-state">Heterogeneity by State</a></li>
  <li><a href="#going-forward" id="toc-going-forward" class="nav-link" data-scroll-target="#going-forward">Going Forward</a></li>
  <li><a href="#contact" id="toc-contact" class="nav-link" data-scroll-target="#contact">ðŸ“¬ Contact</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tracking TC Ownership: Descriptive Stats</h1>
  <div class="quarto-categories">
    <div class="quarto-category">TC Ownership</div>
  </div>
  </div>

<div>
  <div class="description">
    Ownership shares by state over time with animated maps.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>David Hall </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 8, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This is the first blog post in a series specifically geared toward exploring the ownership of substance use disorder treatment centers (TCs). I was motivated to start this series when reading Sloanâ€™s chapter (21) in the Handbook of Health Economics which can be found <a href="https://www.sciencedirect.com/science/article/pii/S1574006400800347">here</a>. I have been reading specifically that chapter of the handbook as I finish some work on a project assessing the impact of a supply shock to the treatment system here in Oregon. At first, I viewed this paper as mostly a straight forward supply shock that would result in a change in admissions to treatment, but as I explored the incentives of the TCs a bit more I believe the question not to be as straight forward. While I was viewing TCs through a more altruistic view â€” that is, assuming funding TCs would lead to increased admissions in particular for those most at risk â€” I had not yet looked into how the market structure for health care does not necessarily predict the same thing.</p>
<p>The purpose of todayâ€™s post is simply to walk through the motivation for exploring the ownership decision of healthcare firms, and particularly hospitals. I then compare some descriptive statistics for the U.S. and at the state-level of the ownership breakdown of TCs. The eventual idea is to understand if the same problems facing hospitals due to ownership allocation can be applied to TCs.</p>
<p>What do I even mean by the ownership decision? That is the decision for a hospital to be private non-profit, private for-profit or publicly owned.</p>
<p>Sloan explains the motivation for exploring ownership in the context of healthcare as follows:</p>
<ol type="1">
<li>Under the view of a firm as a nexus of contracts, the ownership decision is a cost minimizing problem â€” particularly with respect to transaction costs.</li>
<li>Health care is no exception, <em>except</em>, the contracts are a bit more complex than the typical firm.
<ol type="a">
<li>The product purchaser, i.e.&nbsp;the health services consumer (the patient), is often not the full payor (their marginal cost is lower than the true marginal cost).</li>
<li>The product purchaser has less information about the products than the suppliers.</li>
<li>Since the consumer is not the payor, equilibrium determinations are made by comparing the willingness to pay (WTP) of the true payor and the producer, but the payor (e.g.&nbsp;insurance companies) do not reveal their WTP so easily.</li>
</ol></li>
<li>Due to the asymmetric information, hospitals will only provide socially optimal care to the extent they receive direct payment.
<ol type="a">
<li>This means that patients with a lower reimbursement rate or high transaction cost could receive less care than those with higher reimbursement rates.</li>
<li>In other words, the marginal revenue framework of hospitals tells us they are incentivized to treat insured patients.</li>
</ol></li>
</ol>
<p>Social planners know the incentives of hospitals (somewhat) and have created incentives to ensure hospitals provide treatment even to those with low reimbursement rates. One of the most salient examples of this is the provision of charity care by hospitals. Hospitals receive tax breaks for a certain level of charity care provided; property tax at the state level and income tax at the federal level are typical. Note that this doesnâ€™t <em>just</em> apply to hospitals for the most part and extends to any <strong>non-profit</strong>. For-profit hospitals cannot receive this tax break â€” a clear example of the sort of ownership-as-a-cost-minimization I was discussing at the beginning.</p>
<p>If you are interested in more of this work, here are three papers I had been reading. I highly recommend reading the one by Chen (2016) for background: * Hospital Competition and Charity Care, Garmon (2006) <a href="https://www.ftc.gov/reports/hospital-competition-charity-care">here</a> * THE PROVISION OF CHARITY CARE BY NONPROFIT HOSPITALS, Chen <a href="https://repository.upenn.edu/server/api/core/bitstreams/22f3173e-2c7f-4359-bdbb-9f0d3aa41274/content">here</a> - Just a note, this is actually a thesis but I found the background particularly insightful.</p>
</section>
<section id="comparing-the-ownership-of-hospitals-and-tcs-nationally" class="level2">
<h2 class="anchored" data-anchor-id="comparing-the-ownership-of-hospitals-and-tcs-nationally">Comparing the Ownership of Hospitals and TCs Nationally</h2>
<p>I use data from the AHA Annual Survey from 1999-2023, obtained from <a href="https://www.kff.org/other/state-indicator/hospitals-by-ownership/?dataView=1&amp;activeTab=graph&amp;currentTimeframe=0&amp;startTimeframe=24&amp;selectedDistributions=statelocal-government--non-profit--for-profit&amp;selectedRows=%7B%22wrapups%22:%7B%22united-states%22:%7B%7D%7D,%22states%22:%7B%22all%22:%7B%7D%7D%7D&amp;sortModel=%7B%22colId%22:%22Location%22,%22sort%22:%22asc%22%7D">KFF</a> to create the following charts and .gifs.</p>
<p>The following is a chart made directly from KFF data on ownership of hospitals:</p>
<p><img src="../../..\series/TC_Ownership/output/hospitalownership_overtime.png" class="img-fluid"></p>
<p>We can then compare to TC ownership using data from the N-SSATS and N-SUMHSS.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p><img src="../../..\series/TC_Ownership/output/TCs_across_time.png" class="img-fluid"></p>
<p>We can note that the non-profit model has been much consistently dominant for hospitals maintaining the majority of the share of hospital ownership from 1999-2023. In contrast, non-profit ownership â€” while still dominant â€” has seen a steady decrease annually with for-profit firms starting to take over that share.</p>
</section>
<section id="heterogeneity-by-state" class="level2">
<h2 class="anchored" data-anchor-id="heterogeneity-by-state">Heterogeneity by State</h2>
<p>The following maps the by-state heterogeneity across my sample period for TCs on the left and hospitals on the right.</p>
<div class="columns">
<div class="column" style="width:50%;">
<p><img src="../../..\series/TC_Ownership/output/np_share_by_state.gif" class="img-fluid" style="width:100.0%" alt="TCs: Non-profit"></p>
</div><div class="column" style="width:50%;">
<p><img src="../../..\series/TC_Ownership/output/hosp_np_by_state.gif" class="img-fluid" style="width:100.0%" alt="Hospitals: Non-profit"></p>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<p><img src="../../..\series/TC_Ownership/output/fp_share_by_state.gif" class="img-fluid" style="width:100.0%" alt="TCs: For-profit"></p>
</div><div class="column" style="width:50%;">
<p><img src="../../..\series/TC_Ownership/output/hosp_fp_by_state.gif" class="img-fluid" style="width:100.0%" alt="Hospitals: For-profit"></p>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<p><img src="../../..\series/TC_Ownership/output/public_share_by_state.gif" class="img-fluid" style="width:100.0%" alt="TCs: Public"></p>
</div><div class="column" style="width:50%;">
<p><img src="../../..\series/TC_Ownership/output/hosp_public_by_state.gif" class="img-fluid" style="width:100.0%" alt="Hospitals: Public"></p>
</div>
</div>
<p><em>Figure. Ownership shares over time by state (left: Treatment Centers, right: Hospitals).</em></p>
<p>One thing I notice is some regional heterogeneity; specifically in areas of the South. It might be interesting to explore why that is.</p>
<p>Also, as for some states, they may have very many public hospitals comparatively (e.g.&nbsp;Idaho) but most of their TCs are for-profit.</p>
</section>
<section id="going-forward" class="level2">
<h2 class="anchored" data-anchor-id="going-forward">Going Forward</h2>
<p>Much of the empirical literature on hospitals explains why the non-profit form is so dominant, but I canâ€™t quite say that the non-profit form is so dominant among ownership for TCs. For-profit centers are increasing, therefore future posts will consider the profit incentives of a for-profit firm, where they receive most of their funding and what the source of payment (or what they accept) is for the for-profit firm.</p>
<p>In particular, some questions Iâ€™ll be answering:</p>
<ul>
<li><p>What is the breakdown of services offered across ownership?</p>
<ul>
<li><p>Do for-profit TCs offer more revenue-generating services? What are those services?</p>
<ul>
<li>Outpatient/residential?</li>
</ul></li>
</ul></li>
<li><p>Do for-profits have more decision power in who they admit?</p></li>
<li><p>What sort of funding do they receive via revenue (REVCHK in NSSATS/NSUMHSS data) and externally?</p>
<ul>
<li>Checking for possible grants, etc.</li>
</ul></li>
</ul>
<p>Iâ€™m not going to take these figures as absolute fact. There are many reasons a center has to submit data to SAMHSA for the survey, particularly if they receive state/federal funding of any kind. It may be that for-profits have always been fairly present but were not marked in the data across time. If that is the case, I can discuss ways we might think about instrumenting for the true count of for-profit TCs and discerning whether there is a true rise or not.</p>
<p>Please feel free to DM/email me for comments or questions. The code for this project is available on my Github.</p>
</section>
<section id="contact" class="level2">
<h2 class="anchored" data-anchor-id="contact">ðŸ“¬ Contact</h2>
<ul>
<li>Email: <code>dhall7@uoregon.edu</code></li>
<li>GitHub: <a href="https://github.com/studhall">@studhall</a></li>
<li>X/Twitter: <a href="https://x.com/studhall">@studhall</a></li>
</ul>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Note that typically one should not try to compare across N-SSATS and N-SUMHSS as the N-SUMHSS was developed to combine the N-SATSS and N-MHSS and so is not comparable in many ways. In this case, I did restrict the 2021-2023 N-SUMHSS to only TCs, and ownership is a common variable across all years.<a href="#fnref1" class="footnote-back" role="doc-backlink">â†©ï¸Ž</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/studhall\.github\.io\/academicsite");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Â© 2025 David Hall</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>